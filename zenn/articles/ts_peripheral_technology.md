---
title: "TS周りの言葉(技術)を色々調べてみた"
emoji: "😎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

元フルスタックエンジニア(死語)をやらせていただいていたものです。
JavaScript(TS)周りの進歩が凄く、あまりにもついていけていなかったので、気になったワードを片っ端から整理してみました。

それぞれに対する説明の正しくないものが含まれてしまっている可能性があります。
そんなところを見つけたときは優しく教えてくださると助かります。

この記事が誰かの助けになれば幸いです。

## 調査・分類した言葉(技術)たち

- Hono
- Bun
- Deno
- Biome
- Vite
- Webpack
- esbuild
- Bable
- SWC
- Prisma

まず上記に上げたものが、どういった機能を持つものなのかもわかりませんでした。
それを整理すると以下になるようです。

- JavaScript Runtime
  - Deno
  - Bun
  - (Node)
- トランスパイラ
  - Babel
  - SWC
- ビルドツール/Module bundler
  - Vite
  - esbuild
  - Webpack
- Linter/Formatter
  - Biome
  - Prettier/ESLint
- Webフレームワーク
  - Hono
- ORM
  - Prisma

## JavaScript Runtimeとは？

端的に言うと`JavaScriptの実行環境`になります。
JavaScriptの場合、最もよく使われている実行環境且つイメージがしやすいのは「ブラウザ」とかでしょうか。

他にもサーバサイドjsと呼ばれるもので`Node`, `Deno`, `Bun` などがあります。

僕は実行環境というと「プログラムを解析して実行するところ？」と感じてしまったのですが、僕のイメージしていたものは`Engine`と呼ばれるものでした。

概念的にはRuntimeのほうが大きく、Runtimeの中にEngineを含んでいることが多いようです。
※ Engineについて後述します。

しかし実行環境と言われてもいまいちイメージが付きません。これを一言で表すと、どういうものになるのでしょうか。
結論、僕には一言で表せる語彙がなかったので雰囲気として以下のようなものと理解することにしました。

- Runtimeは実行時の環境・構成・処理を管理するシステム群をパッケージングしたシステム
  - 例
    - 実行されるプログラムのアクセスできる範囲を管理するセキュリティ機能
	- 実行されるプログラムが参照するライブラリを管理するパッケージ(Module)マネジメント機能
	- TSを実行可能にするためのトランスパイラ
	- ECMAScript以外のAPIを利用可能にするための実装

Runtimeの中にLinterやFormatterなど他にも多くの機能を含むものもありますが、それはRuntimeというものの特性というよりは開発を便利するために気が利いた追加機能たちなのかなと思いました。

あくまでこれは`JavaScriptのRuntime`と言った場合で、Runtime自体は文脈によって指すものが変わることがあると思います。
単純にプログラムの実行時を指すこともあるので。Runtime Errorとか。

### 各Runtimeの違い

| Runtime | Engine         | Module          |
| ------- | -------------- | --------------- |
| Node    | V8             | CommonJS, ESM*1 |
| Deno    | V8             | ESM, CommonJS*1 |
| Bun     | JavaScriptCore | ESM, CommonJS   |

*1: 対応に課題あり

他にも特徴や比較項目があるのですが、表にして比較しづらいのでテキストで記載します。

- Node
  - デファクトスタンダードであることによって、比較時の基準になるもの
  - Productionで安定稼働させたい場合に、最も枯れているため有力
- Deno
  - Nodeの失敗点を反省してNode作成者の一人が作り始めたもの
  - セキュリティに関して機能が強化されている
    - NodeはファイルシステムやネットワークにフルアクセスだがDenoは許可制
  - パッケージ管理が独特でimport時にパッケージやバージョンを指定
    - npmにあるものを利用することも可能
  - 基本的にESMのみ
  - TS, JSX, TSXサポート
  - Deno deployによるデプロイサポート
- Bun
  - とにかく速い
    - ベンチマークに不正確な点がありという指摘がちらほら
	- とはいえ、遅いということは絶対になさそうで正規表現などは他より速いらしい
  - ESM, CommonJSを混ぜて使える
  - npmに対応
  - TS, JSX, TSXサポート
  - Nodeとの完全互換を目指し中

これらを踏まえて、個人的に感じた使い分けは以下です。

| Runtime | Engine         | Module          |
| ------- | -------------- | --------------- |
| Node    | V8             | CommonJS, ESM*1 |
| Deno    | V8             | ESM, CommonJS*1 |
| Bun     | JavaScriptCore | ESM, CommonJS   |

### JavaScript Engineとは？

凄くざっくりと言ってしまうと、インタプリタやコンパイラにあたるものだと思います。
有名なものに`V8`があります。

これがJavaScriptを実際にパソコンが実行可能なものに変換して実行してくれています。

例えば今回調べた各Runtimeで採用されているEngineは以下のようになっていました。


| Engine         | Runtime |
| -------------- | ------- |
| V8             | Chrome, Node, Deno |
| JavaScriptCore | Safari, Bun |

詳細は割愛します(書けるだけの知識もないんです)が、2024/04/27現在のV8 EngineはJITコンパイラとなっており大雑把には以下のように動作するようです。

1. Engine内のインタプリタでバイトコードを生成
1. バイトコードをインタプリタで逐次処理し機械語にして実行
1. インタプリタでプログラムを実行してる間に情報を蓄積し、ある程度有効な情報が溜まったらコンパイラがより広い範囲で最適化しつつ機械語に変換
1. コンパイルされた機械語を呼び出して実行
1. 必要に応じてバイトコードに戻り、コンパイル
1. 上記を繰り返す

個人的には、こっちのほうが実行環境という名前にふさわしいと思うのですが、世の中的にはそうではないんですかね。

## ひとりごと

以下、調べながら悩んだり思考したログと推測です。推測なので事実かどうかはわかりません。

Q: バイトコード(中間言語)をJavaみたいにコンパイルして先に配置したらいいのに、なんでJSは実行時に変換をするんだろう？
A: jsは引数などに型定義がなく実行時まで型が確定しないので、事前に変換を行えない。仮に変換する場合すべての型に対するビルド結果を生成する必要があり実行ファイルが巨大になる。そのため事前に機械語にもバイトコードにも出来ない。PHP, Ruby, Pythonなどがコンパイルを事前にしないのも同様の理由。

Q: ReactのRuntimeにDeno, Bunどっちを選ぶのが良いんだろう？
A: ReactのRuntimeはブラウザしかないので選択の余地がないはず。Next.jsであればサーバサイドになんのRuntimeを選択するかの余地があるはず。ただRuntimeとしてというよりは、開発環境としてのBun, Denoと考えるのであれば選択できそう。その場合、個人的にはBunで良さそう。


## 参考文献

- [JavaScriptエンジンから見るランタイム](https://speakerdeck.com/shqld/2024-04-25)
- [JavaScript 実行エンジンの V8 を学ぶ]https://cam-inc.co.jp/p/techblog/732526623538021449
- [Wikipedia - インタプリタ](https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%97%E3%83%AA%E3%82%BF)
- [Wikipedia - 実行時コンパイラ](https://ja.wikipedia.org/wiki/%E5%AE%9F%E8%A1%8C%E6%99%82%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9)
- [JavaScript Runtimes (Node.js, Deno, Bun)](https://zenn.dev/mryhryki/articles/2023-09-24-javascript-runtimes)

